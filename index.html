<html>
<head>
  <script type="text/javascript" src="pf-segmentation.js"></script>
  <script type="text/javascript" src="slic-segmentation.js"></script>
  <script type="text/javascript" src="segment-annotator.js"></script>
  <style type="text/css">
    body {
      font-family: Verdana, Arial, sans-serif;
    }
    .legend {
      display: inline-block;
    }
    .legend-item {
      display: inline-block;
      padding: .2em .5em;
      min-width: 8em;
      cursor: pointer;
      background-color: #eee;
    }
    .legend-item:hover {
      background-color: #999;
    }
    .legend-selected {
      background-color: #ccc;
    }

    .mode {
      display: inline-block;
    }
    .mode-item {
      display: inline-block;
      padding: .2em .5em;
      min-width: 8em;
      cursor: pointer;
      background-color: #eee;
    }
    .mode-item:hover {
      background-color: #999;
    }
    .mode-selected {
      background-color: #ccc;
    }


    .legend-delete-button {
      display: inline-block;
      padding: .2em .3em;
      cursor: pointer;
      background-color: #eee;
    }
    .legend-delete-button:hover {
      background-color: #999;
    }
    .legend-color-box {
      display: inline-block;
      border: #000 solid 1px;
      width: .8em;
      height: .8em;
      vertical-align: middle;
    }
    .toggle-button {
      display: inline-block;
      padding: .3em .5em;
      min-width: 6em;
      background-color: #eee;
      cursor: pointer;
    }
    .toggle-button:hover {
      background-color: #999;
    }
    .toggle-button-disabled {
      background-color: #ccc;
    }
    button{
      width: 12em;
      height:2em;
    }

  </style>
</head>
<body>
  <div style="white-space:nowrap;">
    <div id="annotator-container"></div>
    <canvas id="label" ></canvas>
    <div style="display:inline-block;vertical-align:top;padding:0 1em;">
      <p>Mode</p>
      <div id="mode" class="mode"></div><br /> 
      <div id="legend" class="legend"></div>
      <button id="undo-button" type="button">Undo</button> 
      <p>Views</p>
      <div>
        <div id="image-view-button" class="toggle-button">Image</div><br />
        <div id="boundary-view-button" class="toggle-button">Boundary</div><br />
        <div id="fill-view-button" class="toggle-button">Fill</div>
      </div>
      <p>Mode</p>
      <div>
        <div id="import-button" class="toggle-button">Import</div><br />
        <div id="unlabel-button" class="toggle-button">Merge</div>
        <div id="export-button" class="toggle-button">Export</div>
      </div>
    </div>
        <canvas id="part" ></canvas>
  </div>
  <script type="text/javascript">
//test_o: original image
//test_b: only with border
//test_l: border && part labels
//test_s: only with all Subsegment border
   // window.onload = function() {



      //loading label
         var img = new Image();
         window.labelColor, window.modeIndex;
         img.onload = function() {
                var canvas = document.getElementById('label');
                canvas.width = img.width;
                canvas.height = img.height;
                window.context = canvas.getContext('2d');
                context.drawImage(img, 0, 0);
                window.label_imgData = context.getImageData(0, 0, img.width, img.height);       
                context.putImageData(label_imgData,0,0);
              
                var labels =[
                  {  name: 'Sky', color: [0, 0, 255]},
                  {  name: 'Cloud', color: [255, 0, 0]},
                  {  name: 'Clear label', color: [255, 255, 255]},
                ];
                initializeLegend(labels);

                var mode = ['Label', 'Merge', 'Split'];
                initializeMode(mode);
                initializeButtons(); 
         }
         img.src = 'test_l.png';

      //loading original
         var imgOri = new Image();
         imgOri.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = imgOri.width;
                canvas.height = imgOri.height;
                var context = canvas.getContext('2d');
                context.drawImage(imgOri, 0, 0);
                window.ori_imgData = context.getImageData(0, 0, imgOri.width, imgOri.height);    
         }
         imgOri.src = 'test_o.png';

         var imgBorder = new Image();
         imgBorder.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = imgBorder.width;
                canvas.height = imgBorder.height;
                var context = canvas.getContext('2d');
                context.drawImage(imgBorder, 0, 0);
                window.border_imgData = context.getImageData(0, 0, imgBorder.width, imgBorder.height);       
         }
         imgBorder.src = 'test_b.png';


         var imgSubseg = new Image();
         imgSubseg.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = imgSubseg.width;
                canvas.height = imgSubseg.height;
                var context = canvas.getContext('2d');
                context.drawImage(imgSubseg, 0, 0);
                window.Subseg_imgData = context.getImageData(0, 0, imgSubseg.width, imgSubseg.height);       
         }
         imgSubseg.src = 'test_s.png';

      var container = document.getElementById('label');
      container.addEventListener("click", function(event) {
             var hit = [];
             if(modeIndex===0){
                hit.push(getClickPosition(event, this));
                getSegmentPixels(hit);             
             }

      }, false);


   //   function mergeSegement(){
          var route, preHit, point,
              mousestate = {down: false};

          container.addEventListener('mousedown', function(event) {
        //      console.log("*********");
              mousestate.down= true;
              var hit = getClickPosition(event, this);
        //      console.log('Start:   '+hit.x+','+hit.y);
              route = [];
              preHit = getClickPosition(event, this);
          }, false);
          
          container.addEventListener('mousemove', function(event) {
            if(mousestate.down){
              var hit = getClickPosition(event, this);
              route.push(hit);
              preHit = hit;          
             } 
          }, false);
        
          container.addEventListener('mouseup', function(event) {
             mousestate.down = false;
             var hit = getClickPosition(event, this);
             var points = [];
             for(var i =0; i<route.length;i++){
               if(isBorder(route[i].x, route[i].y)){
                 points.push(route[i-1]);
               }
             }
             if(!isBorder(hit.x, hit.y)){
               points.push(hit);
             }
            getSegmentPixels(points);

       //      console.log('Up:   '+hit.x+','+hit.y);
          }, false);
  //    }

      function dilateK(k, width, height){
         var dilatePixels = [];
         manhattanDilate(width, height);

         for (var y=0; y<height; y++){
             for (var x=0; x<width; x++){
                if(indexMap[y*width+x] <= k){
                   indexMap[y*width+x] = 1;
                   dilatePixels.push(y*width+x);
                }
                else{
                   indexMap[y*width+x] = 0;
                }
              }
          }
          
          return dilatePixels;
      }

      function manhattanDilate(width, height){

           for (var y=0; y<height; y++){
               for (var x=0; x<width; x++){
                    if (indexMap[y*width+x] == 1){
                        indexMap[y*width+x] = 0;
                    } else {
                        indexMap[y*width+x] = height + width;
                        if (y>0) indexMap[y*width+x] = Math.min(indexMap[y*width+x], indexMap[(y-1)*width+x]+1);
                        if (x>0) indexMap[y*width+x] = Math.min(indexMap[y*width+x], indexMap[y*width+x-1]+1);
                    }
                }
            }

           for (var y = height-1; y >= 0; y--){
              for (var x = width-1; x >= 0; x--){
                    if (y+1 < height) indexMap[y*width+x] = Math.min(indexMap[y*width+x], indexMap[(y+1)*width+x]+1);
                    if (x+1 < width) indexMap[y*width+x] = Math.min(indexMap[y*width+x], indexMap[y*width+x+1]+1);
              }
           }
     }


     function manhattanErosion(width, height){

           for (var y=0; y<height; y++){
               for (var x=0; x<width; x++){
                    if (indexMap[y*width+x] == 0){
                        indexMap[y*width+x] = 1;
                    } else {
                        indexMap[y*width+x] = -height - width;
                        if (y>0) indexMap[y*width+x] = Math.max(indexMap[y*width+x], indexMap[(y-1)*width+x]-1);
                        if (x>0) indexMap[y*width+x] = Math.max(indexMap[y*width+x], indexMap[y*width+x-1]-1);
                    }
                }
            }

           for (var y = height-1; y >= 0; y--){
              for (var x = width-1; x >= 0; x--){
                    if (y+1 < height) indexMap[y*width+x] = Math.max(indexMap[y*width+x], indexMap[(y+1)*width+x]-1);
                    if (x+1 < width) indexMap[y*width+x] = Math.max(indexMap[y*width+x], indexMap[y*width+x+1]-1);
              }
           }
     }     


      function erosionK(dilatePixels, pixels, ng_k, width, height){

          var fake=[];

          manhattanErosion(width, height);

          for(var i =0; i<dilatePixels.length;i++){
            if(indexMap[dilatePixels[i]] < ng_k){
              fake.push(dilatePixels[i]);
              pixels.push(dilatePixels[i]);
            }
          }

           drawPart(fake);
      }



      function isBorder(x, y){
        var k = y*img.width + x;
        var data = label_imgData.data;
        if(data[4*k+0]===0 && data[4*k+1]===255 && data[4*k+2]===0)
          return true;
        return false;
      }

      function getClickPosition(e, parent){
         var mouse = {x:'', y:''};
         mouse.x = e.pageX - parent.offsetLeft + parent.scrollLeft;
         mouse.y = e.pageY - parent.offsetTop + parent.scrollTop;
         return mouse;

      //    consolze.log('Hit****  X:'+x+';'+'Y:'+y);
      };     

      //indexMap: pixel index = true, if this pixel is added into pixels Array
      function getSegmentPixels(point){
         var pixels = [];
         window.indexMap = new Array(img.width*img.height);
         
         for(var i=0; i< img.width*img.height;++i)
                indexMap[i] = 0;
         
         for(var i =0; i<point.length;i++)
           getPixels(pixels, point[i].x, point[i].y,label_imgData.data,label_imgData.width, label_imgData.height);

         switch(modeIndex){
          //label
           case 0:
             labelSegment(pixels);
             break;
           //merge  
           //k and ad can be further adjusted
           case 1: 
             var k=3;
             var dilatePixels = dilateK(k, img.width, img.height);
             erosionK(dilatePixels, pixels, -k, img.width, img.height);
             labelSegment(pixels); 
             break;
           //split  
           case 2:
             splitSegement(pixels);
             break;
         }
         return pixels;
      }
      

     function drawPart(pixels){

                   var cvs = document.getElementById('part');
                   cvs.width = img.width;
                   cvs.height = img.height;
                   var ctx = cvs.getContext('2d');
                   var imPartData = ctx.getImageData(0, 0, cvs.width, cvs.height);
                   var data = label_imgData.data;

                  for(var i = 0; i < pixels.length; i++){
                        imPartData.data[4*pixels[i]+0] = data[4*pixels[i]+0];
                        imPartData.data[4*pixels[i]+1] = data[4*pixels[i]+1];
                        imPartData.data[4*pixels[i]+2] = data[4*pixels[i]+2];
                        imPartData.data[4*pixels[i]+3] = data[4*pixels[i]+3];
                  }

                  ctx.putImageData(imPartData,0,0);     
     }


      function splitSegement(segPixels){
             for(var i = 0; i < segPixels.length; i++){
                 label_imgData.data[4*segPixels[i]+0] = Subseg_imgData.data[4*segPixels[i]+0];
                 label_imgData.data[4*segPixels[i]+1] = Subseg_imgData.data[4*segPixels[i]+1];
                 label_imgData.data[4*segPixels[i]+2] = Subseg_imgData.data[4*segPixels[i]+2];
                 label_imgData.data[4*segPixels[i]+3] = Subseg_imgData.data[4*segPixels[i]+3];
             }  
             context.putImageData(label_imgData,0,0);    

      }

      function labelSegment(segPixels){

         if (modeIndex===1){
           for(var i=0; i<segPixels.length; i++){
                 label_imgData.data[4*segPixels[i]+0] = ori_imgData.data[4*segPixels[i]+0];
                 label_imgData.data[4*segPixels[i]+1] = ori_imgData.data[4*segPixels[i]+1];
                 label_imgData.data[4*segPixels[i]+2] = ori_imgData.data[4*segPixels[i]+2];
                 label_imgData.data[4*segPixels[i]+3] = ori_imgData.data[4*segPixels[i]+3];

                 border_imgData.data[4*segPixels[i]+0] = ori_imgData.data[4*segPixels[i]+0];
                 border_imgData.data[4*segPixels[i]+1] = ori_imgData.data[4*segPixels[i]+1];
                 border_imgData.data[4*segPixels[i]+2] = ori_imgData.data[4*segPixels[i]+2];
                 border_imgData.data[4*segPixels[i]+3] = ori_imgData.data[4*segPixels[i]+3];
            }  
         }
         else if(labelColor.name =='Clear label'){
            for(var i=0; i<segPixels.length; i++){
                 label_imgData.data[4*segPixels[i]+0] = border_imgData.data[4*segPixels[i]+0];
                 label_imgData.data[4*segPixels[i]+1] = border_imgData.data[4*segPixels[i]+1];
                 label_imgData.data[4*segPixels[i]+2] = border_imgData.data[4*segPixels[i]+2];
                 label_imgData.data[4*segPixels[i]+3] = border_imgData.data[4*segPixels[i]+3];
            }         
         }
         else{
             for(var i = 0; i < segPixels.length; i++){
                 label_imgData.data[4*segPixels[i]+0] = labelColor.color[0];
                 label_imgData.data[4*segPixels[i]+1] = labelColor.color[1];
                 label_imgData.data[4*segPixels[i]+2] = labelColor.color[2];
                 label_imgData.data[4*segPixels[i]+3] = 255;
             }   
         }
         context.putImageData(label_imgData,0,0); 
      }
      
      //green border pixels never added into pixels array
     function getPixels(pixels, x, y, data, width, height){
        var k = y*width + x;
        if (!indexMap[k] && !(data[4*k+0]===0 && data[4*k+1]===255 && data[4*k+2]===0)){
     
          pixels.push(k);
          indexMap[k]=1;
          if(x-1>0)
            getPixels(pixels, x-1, y, data, width, height);
          if(x+1<height)
            getPixels(pixels, x+1, y, data, width, height);
          if(y-1>0)
            getPixels(pixels, x, y-1, data, width, height);
          if(y+1<width)
            getPixels(pixels, x, y+1, data, width, height);
        }
      }
      

      function initializeMode(mode){
         function attachClickEvent(item, i) {
            item.addEventListener('click', function() {
               var selected = document.getElementsByClassName('mode-selected')[0];
               if (selected)
                 selected.classList.remove('mode-selected');
               modeIndex = i;
               this.classList.add('mode-selected');
            });
         }
         var legend = document.getElementById('mode');
         legend.innerHTML = '';
         for (var i = 0; i < mode.length; ++i) {
          // Create an item.
             var item = document.createElement('div');
             item.classList.add('mode-item');
             item.innerHTML += (' ' + mode[i]);
             legend.appendChild(item);
             attachClickEvent(item, i);
         }
         var currentIndex = Math.min(0, mode.length - 1);
         document.getElementsByClassName('mode-item')[currentIndex].click();       
      }


      function initializeLegend(labels){
        function attachClickEvent(item, i) {
          item.addEventListener('click', function() {
            var selected = document.getElementsByClassName('legend-selected')[0];
            if (selected)
              selected.classList.remove('legend-selected');
            labelColor = labels[i];
            this.classList.add('legend-selected');
          });
        }

        for (var i = 0; i < labels.length; ++i) {
          // Create an item.
          var color = labels[i].color;
          var colorbox = document.createElement('span');
          colorbox.classList.add('legend-color-box');
          colorbox.style.backgroundColor =
              'rgb(' + color[0] + ',' + color[1] + ',' + color[2] + ')';
          var item = document.createElement('div');
          item.classList.add('legend-item');
          item.appendChild(colorbox);
          item.innerHTML += (' ' + labels[i].name);
          legend.appendChild(item);
          attachClickEvent(item, i);

          legend.appendChild(document.createElement('br'));
        }
        var currentIndex = Math.min(0, labels.length - 1);
        document.getElementsByClassName('legend-item')[currentIndex].click();
      }

      function mergeSort(array) {
          function sort(array, first, last) {
              first = (first === undefined) ? 0 : first
              last = (last === undefined) ? array.length - 1 : last
              if (last - first < 1) {
                  return;
              }
              var middle = Math.floor((first + last) / 2);
              sort(array, first, middle);
              sort(array, middle + 1, last);

              var f = first,
                  m = middle,
                  i,
                  temp;

              while (f <= m && m + 1 <= last) {
                  if (array[f] >= array[m + 1]) { // 这里使用了插入排序的思想
                      temp = array[m + 1];
                      for (i = m; i >= f; i--) {
                          array[i + 1] = array[i];
                      }
                      array[f] = temp;
                      m++;
                  } else {
                      f++;
                  }
              } 
            return array;
          }
          return sort(array);
      }

      // Create a slide radio input.
      function createToggleButton(button, disableCallback, enableCallback) {
        var enabled = true;
        button.addEventListener('click', function() {
          if (enabled) {
            disableCallback();
            button.classList.add('toggle-button-disabled');
            enabled = !enabled;
          }
          else {
            enableCallback();
            button.classList.remove('toggle-button-disabled');
            enabled = !enabled;
          }
        });
      }
      // Create a local file input.
      function createFileInput(button, callback) {
        var input = document.createElement('input');
        input.type = 'file';
        input.style.display = 'none';
        document.getElementsByTagName('body')[0].appendChild(input);
        input.addEventListener('change', function(event) {
          callback(event.target.files[0]);
        });
        button.addEventListener('click', function() {
          input.click();
        });
      }
      // Download as a file.      
      function downloadAsFile(url, filename) {
        var anchor = document.createElement('a');
        anchor.style.display = 'none';
        document.body.appendChild(anchor);
        anchor.setAttribute('href', url);
        anchor.setAttribute('download', filename);
        anchor.click();
        document.body.removeChild(anchor);
      };
      // Attach button events.
      function initializeButtons(annotator) {
        var fillAlpha = 192;
        var boundaryEnabled = true;
        createToggleButton(document.getElementById('image-view-button'),
                           function() { annotator.setImageAlpha(0); },
                           function() { annotator.setImageAlpha(255); });

        createToggleButton(document.getElementById('boundary-view-button'), function() {
          annotator.setBoundaryAlpha(fillAlpha);
          if (boundaryEnabled)
            annotator.setBoundaryAlpha(0);
          boundaryEnabled = !boundaryEnabled;
        }, function() {
          if (!boundaryEnabled)
            annotator.setBoundaryAlpha(192);
          boundaryEnabled = !boundaryEnabled;
        });

        createToggleButton(document.getElementById('fill-view-button'), function() {
         // fillAlpha = 0;
         // annotator.setFillAlpha(fillAlpha);
         // annotator.setBoundaryAlpha(192);
          context.putImageData(border_imgData,0,0); 
        }, function() {
        /*  fillAlpha = 128;
          annotator.setFillAlpha(fillAlpha);
          if (boundaryEnabled)
            annotator.setBoundaryAlpha(192);
          else
            annotator.setBoundaryAlpha(fillAlpha);*/
          context.putImageData(label_imgData,0,0);
        });
        // Set up json importer.
        createFileInput(document.getElementById('import-button'), function(file) {
          if (file.type === 'application/json') {
            var reader = new FileReader();
            reader.onload = function(event) {
              var data = JSON.parse(event.target.result);
              annotator.setLabels(data.labels);
              annotator.setAnnotation(data.annotation);
              initializeLegend(annotator);
            };
            reader.readAsText(file);
          }
        });
    
        document.getElementById('unlabel-button').addEventListener('click', function() {
         var img = new Image();
         img.src = 'test_o.png';
         img.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var context = canvas.getContext('2d');
                context.drawImage(img, 0, 0);
                var imageData = context.getImageData(0, 0, img.width, img.height);       

                          var data = imageData.data;
                   var pixels = annotator.getPixelsIndex(2);
                   var cvs = document.getElementById('part');
                   cvs.width = img.width;
                   cvs.height = img.height;
                   var ctx = cvs.getContext('2d');
                   var imPartData = ctx.getImageData(0, 0, cvs.width, cvs.height);

                  for(var i = 0; i < pixels.length; i++){
                        imPartData.data[4*pixels[i]+0] = data[4*pixels[i]+0];
                        imPartData.data[4*pixels[i]+1] = data[4*pixels[i]+1];
                        imPartData.data[4*pixels[i]+2] = data[4*pixels[i]+2];
                        imPartData.data[4*pixels[i]+3] = data[4*pixels[i]+3];
                  }

                  ctx.putImageData(imPartData,0,0); 
         }
        });

    
        document.getElementById('export-button').addEventListener('click', function() {
          var data = {
            labels: annotator.getLabels(),
            annotation: annotator.getAnnotation()
          };
          var dataURL = 'data:application/json;charset=utf-8,' +
                        encodeURIComponent(JSON.stringify(data));
          downloadAsFile(dataURL, 'export.json');
        });
      }
//    }
  </script>
</body>
</html>
